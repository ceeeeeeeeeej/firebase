<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Authentication Section -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h1></h1>
            <p class="auth-subtitle"></p>
            
            <div class="auth-tabs">
                <button id="loginTab" class="auth-tab active"></button>
                <button id="signupTab" class="auth-tab"></button>
            </div>
            
            <div id="authForm">
                <input 
                    type="text" 
                    id="authUsername" 
                    placeholder="Username" 
                    class="auth-input"
                    style="display: none;"
                >
                <input 
                    type="text" 
                    id="authEmailOrUsername" 
                    placeholder="Email or Username" 
                    class="auth-input"
                >
                <input 
                    type="email" 
                    id="authEmail" 
                    placeholder="Email" 
                    class="auth-input"
                    style="display: none;"
                >
                <div class="password-error" id="passwordError" style="display: none;">
                    Password must be at least 3 characters
                </div>
                <input 
                    type="password" 
                    id="authPassword" 
                    placeholder="Password (min 3 chars)" 
                    class="auth-input"
                >
                <button id="authBtn" class="auth-btn">Login</button>
                <div class="divider">
                </div>
               
                <div id="authStatus" class="auth-status"></div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="header-bar">
            <div>
                <h1></h1>
                <p class="subtitle"></p>
            </div>
            <div class="user-info">
                <span id="userEmail" class="user-email"></span>
                <button id="signOutBtn" class="sign-out-btn">Logout</button>
            </div>
        </div>
        
        <div class="input-section">
            <input 
                type="text" 
                id="titleInput" 
                placeholder="Enter title..." 
                class="title-input"
            >
            <textarea 
                id="textInput" 
                placeholder="Enter your text here..." 
                class="text-input"
                rows="5"
            ></textarea>
            <button id="addBtn" class="add-btn">Add Text</button>
        </div>

        <div class="status" id="status"></div>

        <div class="display-section">
            <div class="section-header">
                <h2></h2>
                <button id="refreshBtn" class="refresh-btn">Refresh</button>
            </div>
            <div id="textList" class="text-list">
                <p class="loading">Loading texts...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, serverTimestamp, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCEJuB2TcmSoPWQvzIL8ofwsrTrustAjEw",
            authDomain: "activity-no.firebaseapp.com",
            projectId: "activity-no",
            storageBucket: "activity-no.firebasestorage.app",
            messagingSenderId: "643465928050",
            appId: "1:643465928050:android:a902a50e46cdd9dfa211eb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;

        // DOM elements - Auth
        const authContainer = document.getElementById('authContainer');
        const mainContainer = document.getElementById('mainContainer');
        const authUsername = document.getElementById('authUsername');
        const authEmailOrUsername = document.getElementById('authEmailOrUsername');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const passwordError = document.getElementById('passwordError');
        const authBtn = document.getElementById('authBtn');
        const authStatus = document.getElementById('authStatus');
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const signOutBtn = document.getElementById('signOutBtn');
        const userEmailDisplay = document.getElementById('userEmail');
        
        // DOM elements - Main App
        const titleInput = document.getElementById('titleInput');
        const textInput = document.getElementById('textInput');
        const addBtn = document.getElementById('addBtn');
        const textList = document.getElementById('textList');
        const status = document.getElementById('status');
        const refreshBtn = document.getElementById('refreshBtn');
        
        let isLoginMode = true;

        // Authentication State Observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                mainContainer.style.display = 'block';
                
                // Display user info
                // Try to load username from Firestore
                loadUsername(user.uid).then(username => {
                    if (username) {
                        userEmailDisplay.textContent = `@${username}`;
                    } else {
                        userEmailDisplay.textContent = user.email;
                    }
                });
                
                loadTexts();
            } else {
                currentUser = null;
                authContainer.style.display = 'flex';
                mainContainer.style.display = 'none';
            }
        });

        // Auth tab switching
        loginTab.addEventListener('click', () => {
            isLoginMode = true;
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            authBtn.textContent = 'Login';
            authStatus.textContent = '';
            
            // Show email or username field for login
            authEmailOrUsername.style.display = 'block';
            authEmail.style.display = 'none';
            authUsername.style.display = 'none';
        });

        signupTab.addEventListener('click', () => {
            isLoginMode = false;
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            authBtn.textContent = 'Sign Up';
            authStatus.textContent = '';
            
            // Show separate username and email fields for signup
            authEmailOrUsername.style.display = 'none';
            authEmail.style.display = 'block';
            authUsername.style.display = 'block';
        });

        // Load username from Firestore
        async function loadUsername(userId) {
            try {
                const q = query(collection(db, 'users'), where('userId', '==', userId));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].data().username;
                }
            } catch (error) {
                console.error('Error loading username:', error);
            }
            return null;
        }

        // Get email from username
        async function getEmailFromUsername(username) {
            try {
                const q = query(collection(db, 'users'), where('username', '==', username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].data().email;
                }
            } catch (error) {
                console.error('Error getting email from username:', error);
            }
            return null;
        }

        // Check if username exists
        async function usernameExists(username) {
            try {
                const q = query(collection(db, 'users'), where('username', '==', username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Error checking username:', error);
                return false;
            }
        }

        // Handle authentication
        authBtn.addEventListener('click', async () => {
            const password = authPassword.value.trim();

            if (isLoginMode) {
                // Login mode
                const emailOrUsername = authEmailOrUsername.value.trim();
                
                if (!emailOrUsername || !password) {
                    showAuthStatus('Please enter email/username and password', 'error');
                    return;
                }

                authBtn.disabled = true;
                authBtn.textContent = 'Logging in...';

                try {
                    let email = emailOrUsername;
                    
                    // Check if input is email or username
                    if (!emailOrUsername.includes('@')) {
                        // It's a username, get the email
                        const foundEmail = await getEmailFromUsername(emailOrUsername);
                        if (!foundEmail) {
                            showAuthStatus('Username not found', 'error');
                            authBtn.disabled = false;
                            authBtn.textContent = 'Login';
                            return;
                        }
                        email = foundEmail;
                    }

                    await signInWithEmailAndPassword(auth, email, password);
                    showAuthStatus('Login successful!', 'success');
                    authEmailOrUsername.value = '';
                    authPassword.value = '';
                } catch (error) {
                    console.error('Auth error:', error);
                    let message = error.message;
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        message = 'Invalid credentials';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Invalid email format';
                    }
                    showAuthStatus(message, 'error');
                } finally {
                    authBtn.disabled = false;
                    authBtn.textContent = 'Login';
                }
            } else {
                // Signup mode
                const username = authUsername.value.trim();
                const email = authEmail.value.trim();
                
                if (!username || !email || !password) {
                    showAuthStatus('Please fill all fields', 'error');
                    return;
                }

                // Validate username
                if (username.length < 3) {
                    showAuthStatus('Username must be at least 3 characters', 'error');
                    return;
                }

                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    showAuthStatus('Username can only contain letters, numbers, and underscores', 'error');
                    return;
                }

                // Validate password
                if (password.length < 3) {
                    passwordError.style.display = 'block';
                    passwordError.textContent = 'Password must be at least 3 characters';
                    return;
                } else {
                    passwordError.style.display = 'none';
                }

                authBtn.disabled = true;
                authBtn.textContent = 'Signing up...';

                try {
                    // Check if username already exists
                    if (await usernameExists(username)) {
                        showAuthStatus('Username already taken', 'error');
                        authBtn.disabled = false;
                        authBtn.textContent = 'Sign Up';
                        return;
                    }

                    // Create account
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Store username in Firestore
                    await addDoc(collection(db, 'users'), {
                        userId: userCredential.user.uid,
                        username: username.toLowerCase(),
                        email: email,
                        createdAt: new Date().toISOString()
                    });

                    showAuthStatus('Account created successfully!', 'success');
                    authUsername.value = '';
                    authEmail.value = '';
                    authPassword.value = '';
                } catch (error) {
                    console.error('Auth error:', error);
                    let message = error.message;
                    if (error.code === 'auth/email-already-in-use') {
                        message = 'Email already in use';
                    } else if (error.code === 'auth/weak-password') {
                        message = 'Password should be at least 3 characters';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Invalid email address';
                    }
                    showAuthStatus(message, 'error');
                } finally {
                    authBtn.disabled = false;
                    authBtn.textContent = 'Sign Up';
                }
            }
        });

        // Sign out
        signOutBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to sign out?')) {
                return;
            }

            try {
                await signOut(auth);
                showAuthStatus('Signed out successfully', 'success');
            } catch (error) {
                console.error('Sign out error:', error);
                showAuthStatus('Error signing out', 'error');
            }
        });

        // Show auth status message
        function showAuthStatus(message, type = 'success') {
            authStatus.textContent = message;
            authStatus.className = `auth-status ${type}`;
            authStatus.style.display = 'block';
        }

        // Show status message
        function showStatus(message, type = 'success') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // Add text to Firestore
        async function addText() {
            const title = titleInput.value.trim();
            const text = textInput.value.trim();
            
            if (!title) {
                showStatus('Please enter a title!', 'error');
                return;
            }
            
            if (!text) {
                showStatus('Please enter some text!', 'error');
                return;
            }

            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                await addDoc(collection(db, 'texts'), {
                    title: title,
                    content: text,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: serverTimestamp(),
                    createdAt: new Date().toISOString()
                });

                titleInput.value = '';
                textInput.value = '';
                showStatus('✓ Text added successfully!', 'success');
                loadTexts(); // Refresh the list
            } catch (error) {
                console.error('Error adding text:', error);
                showStatus('✗ Error adding text: ' + error.message, 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add Text';
            }
        }

        // Load texts from Firestore
        async function loadTexts() {
            if (!currentUser) return;
            
            textList.innerHTML = '<p class="loading">Loading texts...</p>';

            try {
                const q = query(
                    collection(db, 'texts'), 
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    textList.innerHTML = '<p class="empty-state">No texts yet. Add your first one!</p>';
                    return;
                }

                textList.innerHTML = '';
                
                querySnapshot.forEach((document) => {
                    const data = document.data();
                    const textItem = createTextItem(document.id, data.title, data.content, data.createdAt);
                    textList.appendChild(textItem);
                });
            } catch (error) {
                console.error('Error loading texts:', error);
                
                if (error.message && error.message.includes('index')) {
                    textList.innerHTML = `
                        <div class="error-box">
                            <h3>⚠️ Database Index Required</h3>
                            <p>Firebase needs to create an index for this query.</p>
                            <p><strong>Steps to fix:</strong></p>
                            <ol>
                                <li>Click the "Create Index" button below</li>
                                <li>Wait 1-2 minutes for the index to build</li>
                                <li>Click the "Refresh" button above</li>
                            </ol>
                            <a href="${extractIndexUrl(error.message)}" target="_blank" class="create-index-btn">
                                🔧 Create Index in Firebase
                            </a>
                        </div>
                    `;
                } else {
                    textList.innerHTML = `<p class="error">Error loading texts: ${error.message}</p>`;
                }
            }
        }

        // Extract index URL from error message
        function extractIndexUrl(errorMessage) {
            const match = errorMessage.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
            return match ? match[0] : 'https://console.firebase.google.com/project/activity-no/firestore/indexes';
        }

        // Create text item element
        function createTextItem(id, title, content, timestamp) {
            const div = document.createElement('div');
            div.className = 'text-item';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'text-title';
            titleDiv.textContent = title || 'Untitled';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'text-content';
            contentDiv.textContent = content;
            
            div.appendChild(titleDiv);
            div.appendChild(contentDiv);
            
            const metaDiv = document.createElement('div');
            metaDiv.className = 'text-meta';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-time';
            timeSpan.textContent = formatDate(timestamp);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'text-actions';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = '📋 Copy';
            copyBtn.onclick = () => copyText(title, content, copyBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '🗑️ Delete';
            deleteBtn.onclick = () => deleteText(id);
            
            actionsDiv.appendChild(copyBtn);
            actionsDiv.appendChild(deleteBtn);
            
            metaDiv.appendChild(timeSpan);
            metaDiv.appendChild(actionsDiv);
            
            div.appendChild(metaDiv);
            
            return div;
        }

        // Copy text to clipboard
        async function copyText(title, content, button) {
            const textToCopy = `${title}\n\n${content}`;
            
            try {
                await navigator.clipboard.writeText(textToCopy);
                
                // Change button text temporarily
                const originalText = button.textContent;
                button.textContent = '✓ Copied!';
                button.style.background = '#2ecc71';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
                
                showStatus('✓ Text copied to clipboard!', 'success');
            } catch (error) {
                console.error('Error copying text:', error);
                showStatus('✗ Error copying text: ' + error.message, 'error');
            }
        }

        // Delete text from Firestore
        async function deleteText(id) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'texts', id));
                showStatus('✓ Entry deleted successfully!', 'success');
                loadTexts();
            } catch (error) {
                console.error('Error deleting entry:', error);
                showStatus('✗ Error deleting entry: ' + error.message, 'error');
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Just now';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Event listeners
        addBtn.addEventListener('click', addText);
        refreshBtn.addEventListener('click', loadTexts);
        
        titleInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                textInput.focus();
            }
        });
        
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                addText();
            }
        });

        // Enter to login/signup
        authPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authBtn.click();
            }
        });

        // Real-time password validation
        authPassword.addEventListener('input', () => {
            const password = authPassword.value.trim();
            if (password.length > 0 && password.length < 3) {
                passwordError.style.display = 'block';
                passwordError.textContent = 'Password must be at least 3 characters';
            } else {
                passwordError.style.display = 'none';
            }
        });

        authEmailOrUsername.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authPassword.focus();
            }
        });

        authEmail.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authPassword.focus();
            }
        });

        authUsername.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                authEmail.focus();
            }
        });
    </script>
</body>
</html>

